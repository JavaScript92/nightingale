{"version":3,"file":"index.js","sources":["../../../node_modules/style-inject/dist/style-inject.es.js","../src/protvista-structure.js","../src/index.js"],"sourcesContent":["function styleInject(css, ref) {\n  if ( ref === void 0 ) ref = {};\n  var insertAt = ref.insertAt;\n\n  if (!css || typeof document === 'undefined') { return; }\n\n  var head = document.head || document.getElementsByTagName('head')[0];\n  var style = document.createElement('style');\n  style.type = 'text/css';\n\n  if (insertAt === 'top') {\n    if (head.firstChild) {\n      head.insertBefore(style, head.firstChild);\n    } else {\n      head.appendChild(style);\n    }\n  } else {\n    head.appendChild(style);\n  }\n\n  if (style.styleSheet) {\n    style.styleSheet.cssText = css;\n  } else {\n    style.appendChild(document.createTextNode(css));\n  }\n}\n\nexport default styleInject;\n","// import 'litemol/dist/css/LiteMol-plugin.css';Styles rely on fonts being ../fonts\nimport LiteMol from 'litemol';\nimport 'whatwg-fetch';\nimport '../style/style.css';\n\nclass ProtvistaStructure extends HTMLElement {\n    constructor() {\n        super();\n        this._mappings = [];\n        this._highlightstart = parseInt(this.getAttribute('highlightstart'));\n        this._highlightend = parseInt(this.getAttribute('highlightend'));\n        this.pdbId = this.getAttribute('pdbId') ? this.getAttribute('pdbId') : '';\n        this.loadMolecule = this.loadMolecule.bind(this);\n        this.loadStructureTable = this.loadStructureTable.bind(this);\n        this._planHighlight = this._planHighlight.bind(this);\n    }\n\n    get accession() {\n        return this.getAttribute('accession');\n    }\n\n    set accession(accession) {\n        return this.setAttribute('accession', accession);\n    }\n\n    get isManaged() {\n        return true;\n    }\n\n    get isResidueOnlyHighlight() {\n        return this.hasAttribute('highlightresidues');\n    }\n\n    connectedCallback() {\n        this.titleContainer = document.createElement('h4');\n        const flexContainer = document.createElement('div');\n        flexContainer.className = 'main-container';\n        this.titleContainer.id = 'litemol-title';\n        this.tableDiv = document.createElement('div');\n        this.tableDiv.className = 'table-container';\n        const litemolDiv = document.createElement('div');\n        litemolDiv.className = 'litemol-container';\n        litemolDiv.id = 'app';\n        this.messageContainer = document.createElement('span');\n        this.appendChild(this.titleContainer);\n        this.appendChild(this.messageContainer);\n        this.appendChild(flexContainer);\n        flexContainer.appendChild(litemolDiv);\n        flexContainer.appendChild(this.tableDiv);\n        this.loadLiteMol();\n        this.loadUniProtEntry().then(entry => {\n            this._pdbEntries = entry.dbReferences.filter(dbref => dbref.type === 'PDB').map(d => {\n                return {\n                    id: d.id,\n                    properties: {\n                        method: this.formatMethod(d.properties.method),\n                        chains: this.getChains(d.properties.chains),\n                        resolution: this.formatAngstrom(d.properties.resolution)\n                    }\n                };\n            });\n            if (this._pdbEntries.length <= 0) {\n                this.style.display = 'none';\n                return;\n            }\n            this.loadStructureTable();\n            this.selectMolecule(\n                this._pdbEntries.filter(d => d.properties.method !== 'Model')[0].id\n            );\n        });\n    }\n\n    static get observedAttributes() {\n        return ['highlightstart', 'highlightend', 'molecule', 'highlightresidues'];\n    }\n\n    attributeChangedCallback(attrName, oldVal, newVal) {\n        if (oldVal !== newVal) {\n            const value = parseFloat(newVal);\n            this[`_${attrName}`] = isNaN(value) ? newVal : value;\n            if (attrName === 'molecule') {\n                this.selectMolecule(newVal);\n            }\n            this._planHighlight(true);\n        }\n    }\n\n    _planHighlight(withSelection = false) {\n        // console.log('planning highlighting');\n        // If rendering is already planned, skip the rest\n        if (this._plannedRender) return;\n        // Set a flag and _planRender at the next frame\n        this._plannedRender = true;\n        requestAnimationFrame(() => {\n            // Removes the planned rendering flag\n            this._plannedRender = false;\n            if (!this._selectedMolecule) {\n                return;\n            }\n            if (withSelection) {\n                this._selectMoleculeWithinRange(this._highlightstart, this._highlightend).then(() =>\n                    this.highlightChain()\n                );\n            } else {\n                this.highlightChain();\n            }\n            // console.log('highlight called');\n        });\n    }\n\n    async loadUniProtEntry() {\n        try {\n            return await (await fetch(\n                `https://www.ebi.ac.uk/proteins/api/proteins/${this.accession}`\n            )).json();\n        } catch (e) {\n            this.addMessage(`Couldn't load UniProt entry`);\n            throw new Error(e);\n        }\n    }\n\n    async loadPDBEntry(pdbId) {\n        try {\n            const data = await fetch(`https://www.ebi.ac.uk/pdbe/api/mappings/uniprot/${pdbId}`);\n            return await data.json();\n        } catch (e) {\n            this.addMessage(`Couldn't load PDB entry`);\n            throw new Error(e);\n        }\n    }\n\n    loadStructureTable() {\n        const html = `\n            <table>\n                <thead>\n                    <th>PDB Entry</th>\n                    <th>Method</th>\n                    <th>Resolution</th>\n                    <th>Chain</th>\n                    <th>Positions</th>\n                    <th>Links</th>\n                </thead>\n                <tbody>\n                    ${this._pdbEntries\n                        .map(\n                            d => `\n                        <tr id=\"entry_${d.id}\" class=\"${\n                                d.properties.method === 'Model' ? 'pdb-row' : 'pdb-row-clickable'\n                            }\" title=\"${\n                                d.properties.method === 'Model'\n                                    ? 'No structure available for this model'\n                                    : ''\n                            }\">\n                            <td>\n                            <strong>${d.id}</strong><br/>\n                            </td>\n                            <td title=\"${d.properties.method}\">${d.properties.method}</td>\n                            <td>${d.properties.resolution}</td>\n                            <td>${d.properties.chains.map(chain=> \n                                `<div title=\"${chain.chains}\">${chain.chain}</div>`\n                            ).join('')}</td>\n                            <td>${d.properties.chains.map(chain=> `<div>${chain.start}-${chain.end}</div>`).join('')}</td>\n                            <td>\n                                <a target=\"_blank\" title=\"Protein Data Bank Europe\" href=\"//www.ebi.ac.uk/pdbe/entry/pdb/${\n                                    d.id\n                                }\">PDBe</a><br> \n                                <a target=\"_blank\" title=\"Protein Data Bank RCSB\" href=\"//www.rcsb.org/pdb/explore/explore.do?pdbId=${\n                                    d.id\n                                }\">RCSB PDBi</a><br>\n                                <a target=\"_blank\" title=\"Protein Data Bank Japan\" href=\"//pdbj.org/mine/summary/${\n                                    d.id\n                                }\">PDBj</a><br>\n                                <a target=\"_blank\" href=\"//www.ebi.ac.uk/thornton-srv/databases/cgi-bin/pdbsum/GetPage.pl?pdbcode=${\n                                    d.id\n                                }\">PDBsum</a>\n                            </td>\n                        </tr>\n                    `\n                        )\n                        .join('')}\n                </tbody>\n            </table>\n        `;\n        this.tableDiv.innerHTML = html;\n        this.querySelectorAll('.pdb-row-clickable').forEach(row =>\n            row.addEventListener('click', () => this.selectMolecule(row.id.replace('entry_', '')))\n        );\n    }\n\n    getChains(chains) {\n        return chains.split(',').map(chain => {\n            const split = chain.trim().split('=')\n            return {\n                chain: split[0],\n                start: split[1].split('-')[0],\n                end: split[1].split('-')[1],\n            }\n        });\n    }\n\n    formatMethod(method) {\n        switch (method) {\n            case 'EM':\n                return 'Electron microscopy'\n            default:\n                return method;\n        }\n    }\n\n    async selectMolecule(id) {\n        const pdbEntry = await this.loadPDBEntry(id);\n        const mappings = this.processMapping(pdbEntry);\n        this.querySelectorAll('.active').forEach(row => row.classList.remove('active'));\n        this.querySelector(`#entry_${id}`).classList.add('active');\n        await this.loadMolecule(id);\n        this._selectedMolecule = {\n            id: id,\n            mappings: mappings\n        };\n        this._planHighlight();\n    }\n\n    loadLiteMol() {\n        const Plugin = LiteMol.Plugin;\n        this.Command = LiteMol.Bootstrap.Command;\n        this.Query = LiteMol.Core.Structure.Query;\n        this.Bootstrap = LiteMol.Bootstrap;\n        this.Core = LiteMol.Core;\n        this.Tree = this.Bootstrap.Tree;\n        this.CoreVis = LiteMol.Visualization;\n        this.Transformer = this.Bootstrap.Entity.Transformer;\n        this.Visualization = this.Bootstrap.Visualization;\n        this.Event = this.Bootstrap.Event;\n        this.Context = Plugin.Components.Context;\n        // Plugin.Components.Context.Log(this.Bootstrap.Components.LayoutRegion.Bottom, true);\n        this._liteMol = Plugin.create({\n            target: '#app',\n            viewportBackground: '#fff',\n            layoutState: {\n                hideControls: true\n            },\n            allowAnalytics: false\n        });\n\n        this._liteMol.context.highlight.addProvider(info => {\n            // This is triggered on highlight\n        });\n    }\n\n    loadMolecule(_id) {\n        this._liteMol.clear();\n\n        let transform = this._liteMol.createTransform();\n\n        transform\n            .add(this._liteMol.root, this.Transformer.Data.Download, {\n                url: `https://www.ebi.ac.uk/pdbe/coordinates/${_id.toLowerCase()}/full?encoding=BCIF`,\n                type: 'Binary',\n                _id\n            })\n            .then(\n                this.Transformer.Data.ParseBinaryCif, {\n                    id: _id\n                }, {\n                    isBinding: true,\n                    ref: 'cifDict'\n                }\n            )\n            .then(\n                this.Transformer.Molecule.CreateFromMmCif, {\n                    blockIndex: 0\n                }, {\n                    isBinding: true\n                }\n            )\n            .then(\n                this.Transformer.Molecule.CreateModel, {\n                    modelIndex: 0\n                }, {\n                    isBinding: false,\n                    ref: 'model'\n                }\n            )\n            .then(this.Transformer.Molecule.CreateMacromoleculeVisual, {\n                polymer: true,\n                polymerRef: 'polymer-visual',\n                het: true,\n                water: true\n            });\n\n        return this._liteMol.applyTransform(transform);\n    }\n\n    getTheme() {\n        let colors = new Map();\n        colors.set('Uniform', this.CoreVis.Color.fromRgb(207, 178, 178));\n        colors.set('Selection', this.CoreVis.Color.fromRgb(255, 255, 0));\n        colors.set('Highlight', this.CoreVis.Theme.Default.HighlightColor);\n        return this.Visualization.Molecule.uniformThemeProvider(void 0, {\n            colors: colors\n        });\n    }\n\n    addMessage(message) {\n        this.removeMessage();\n        this._liteMol.command(this.Bootstrap.Command.Toast.Show, {\n            key: 'UPMessage',\n            message: message,\n            timeoutMs: 30 * 1000\n        });\n    }\n\n    removeMessage() {\n        this._liteMol.command(this.Bootstrap.Command.Toast.Hide, {\n            key: 'UPMessage'\n        });\n    }\n\n    processMapping(mappingData) {\n        if (!Object.values(mappingData)[0].UniProt[this.accession]) return;\n        return Object.values(mappingData)[0].UniProt[this.accession].mappings;\n    }\n\n    translatePositions(start, end) {\n        // return if they have been set to 'undefined'\n        if (\n            'string' === typeof this._highlightend ||\n            'string' === typeof this._highlightstart\n        ) {\n            return;\n        }\n        for (const mapping of this._selectedMolecule.mappings) {\n            if (\n                mapping.unp_end - mapping.unp_start ===\n                mapping.end.residue_number - mapping.start.residue_number\n            ) {\n                if (start >= mapping.unp_start && end <= mapping.unp_end) {\n                    const offset = mapping.unp_start - mapping.start.residue_number;\n                    //TODO this is wrong because there are gaps in the PDB sequence\n                    return {\n                        entity: mapping.entity_id,\n                        chain: mapping.chain_id,\n                        start: start - offset,\n                        end: end - offset\n                    };\n                } else {\n                    this.addMessage(`Positions ${this._highlightstart}-${\n                        this._highlightend\n                    } not found in this structure`);\n                }\n            } else {\n                this.addMessage('Mismatch between protein sequence and structure residues');\n            }\n        }\n    }\n\n    highlightChain() {\n        if (!this._highlightstart || !this._highlightend) return;\n        this.Command.Visual.ResetTheme.dispatch(this._liteMol.context, void 0);\n        this.Command.Tree.RemoveNode.dispatch(this._liteMol.context, 'sequence-selection');\n\n        const visual = this._liteMol.context.select('polymer-visual')[0];\n        if (!visual) return;\n\n        const translatedPos = this.translatePositions(this._highlightstart, this._highlightend);\n        if (!translatedPos) return;\n\n        let query = null;\n\n        if (this.isResidueOnlyHighlight) {\n            query = this.Query.residues({\n                entityId: translatedPos.entity.toString(),\n                seqNumber: translatedPos.start\n            }, {\n                entityId: translatedPos.entity.toString(),\n                seqNumber: translatedPos.end\n            });\n        } else {\n            query = this.Query.sequence(\n                translatedPos.entity.toString(), translatedPos.chain, {\n                    seqNumber: translatedPos.start\n                }, {\n                    seqNumber: translatedPos.end\n                }\n            );\n        }\n\n        const theme = this.getTheme();\n\n        const action = this._liteMol.createTransform().add(\n            visual,\n            this.Transformer.Molecule.CreateSelectionFromQuery, {\n                query: query,\n                name: 'My name'\n            }, {\n                ref: 'sequence-selection'\n            }\n        );\n\n        this._liteMol.applyTransform(action).then(() => {\n            this.Command.Visual.UpdateBasicTheme.dispatch(this._liteMol.context, {\n                visual: visual,\n                theme: theme\n            });\n            // this.Command.Entity.Focus.dispatch(\n            //     this._liteMol.context,\n            //     this._liteMol.context.select('sequence-selection')\n            // );\n        });\n        this.removeMessage();\n    }\n\n    async _selectMoleculeWithinRange(start, end) {\n        if (!this._pdbEntries) {\n            return;\n        }\n        const matches = this._pdbEntries.filter(\n            d => {\n                return d.properties.method !== 'Model' && d.properties.chains.filter(chain => {\n                    return chain.start <= start && chain.end >= end\n                }).length > 0;\n            }\n        );\n        if (this._selectedMolecule) {\n            if (\n                this._selectedMolecule.mappings.filter(\n                    d => d.unp_start <= start && d.unp_end >= end\n                ).length > 0\n            ) {\n                return;\n            }\n        }\n        if (matches && matches.length > 0) {\n            await this.selectMolecule(matches[0].id);\n        }\n    }\n\n    formatAngstrom(val) {\n        if (!val) return '';\n        return val.replace('A', '&#8491;');\n    }\n}\n\nexport default ProtvistaStructure;","import ProtvistaStructure from './protvista-structure';\n\nconst loadComponent = function() {\n    customElements.define('protvista-structure', ProtvistaStructure);\n};\n\n// Conditional loading of polyfill\nif (window.customElements) {\n    loadComponent();\n} else {\n    document.addEventListener('WebComponentsReady', function() {\n        loadComponent();\n    });\n}\n"],"names":["styleInject","css","ref","insertAt","document","head","getElementsByTagName","style","createElement","type","firstChild","insertBefore","appendChild","styleSheet","cssText","createTextNode","ProtvistaStructure","HTMLElement","constructor","_mappings","_highlightstart","parseInt","getAttribute","_highlightend","pdbId","loadMolecule","bind","loadStructureTable","_planHighlight","accession","setAttribute","isManaged","isResidueOnlyHighlight","hasAttribute","connectedCallback","titleContainer","flexContainer","className","id","tableDiv","litemolDiv","messageContainer","loadLiteMol","loadUniProtEntry","then","entry","_pdbEntries","dbReferences","filter","dbref","map","d","properties","method","formatMethod","chains","getChains","resolution","formatAngstrom","length","display","selectMolecule","observedAttributes","attributeChangedCallback","attrName","oldVal","newVal","value","parseFloat","isNaN","withSelection","_plannedRender","requestAnimationFrame","_selectedMolecule","_selectMoleculeWithinRange","highlightChain","fetch","json","e","addMessage","Error","loadPDBEntry","data","html","chain","join","start","end","innerHTML","querySelectorAll","forEach","row","addEventListener","replace","split","trim","pdbEntry","mappings","processMapping","classList","remove","querySelector","add","Plugin","LiteMol","Command","Bootstrap","Query","Core","Structure","Tree","CoreVis","Visualization","Transformer","Entity","Event","Context","Components","_liteMol","create","target","viewportBackground","layoutState","hideControls","allowAnalytics","context","highlight","addProvider","info","_id","clear","transform","createTransform","root","Data","Download","url","toLowerCase","ParseBinaryCif","isBinding","Molecule","CreateFromMmCif","blockIndex","CreateModel","modelIndex","CreateMacromoleculeVisual","polymer","polymerRef","het","water","applyTransform","getTheme","colors","Map","set","Color","fromRgb","Theme","Default","HighlightColor","uniformThemeProvider","message","removeMessage","command","Toast","Show","key","timeoutMs","Hide","mappingData","Object","values","UniProt","translatePositions","mapping","unp_end","unp_start","residue_number","offset","entity","entity_id","chain_id","Visual","ResetTheme","dispatch","RemoveNode","visual","select","translatedPos","query","residues","entityId","toString","seqNumber","sequence","theme","action","CreateSelectionFromQuery","name","UpdateBasicTheme","matches","val","loadComponent","customElements","define","window"],"mappings":"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"}