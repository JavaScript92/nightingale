{"version":3,"file":"protvista-zoomable.js","sources":["../src/protvista-zoomable.js","../src/main.js"],"sourcesContent":["import * as d3 from 'd3';\n\nclass ProtvistaZoomable extends HTMLElement {\n\n    constructor() {\n        super();\n        this.style.display = 'block';\n        this.style.width = '100%';\n        this.width = this.offsetWidth;\n\n        this._length = this.getAttribute('length') ? parseFloat(this.getAttribute('length')) : 0;\n\n        this.displaystart = this.getAttribute('displaystart')\n            ? parseFloat(this.getAttribute('displaystart'))\n            : 0;\n        this.displayend = this.getAttribute('displayend')\n            ? parseFloat(this.getAttribute('displayend'))\n            : this.width;\n\n        this.updateScaleDomain = this.updateScaleDomain.bind(this);\n        this.initZoom = this.initZoom.bind(this);\n        this.zoomed = this.zoomed.bind(this);\n        this._applyZoomTranslation = this.applyZoomTranslation.bind(this);\n        let aboutToApply = false;\n        this.applyZoomTranslation = () => {\n          if (aboutToApply) return;\n          aboutToApply = true;\n          requestAnimationFrame(() => {\n            aboutToApply = false;\n            this._applyZoomTranslation();\n          });\n        }\n        this.listenForResize = this.listenForResize.bind(this);\n\n        this.updateScaleDomain();\n        this._originXScale = this.xScale.copy();\n        this.initZoom();\n        this.listenForResize();\n    }\n\n    get width() {\n        return this._width;\n    }\n\n    set width(width) {\n        this._width = width;\n    }\n\n    set length(length) {\n        this._length = length;\n    }\n\n    get length() {\n        return this._length;\n    }\n\n    get xScale() {\n        return this._xScale\n    }\n\n    set xScale(xScale) {\n        this._xScale = xScale;\n    }\n\n    get zoom() {\n        return this._zoom;\n    }\n\n    set svg(svg) {\n        this._svg = svg;\n        svg.call(this._zoom);\n        this.applyZoomTranslation();\n    }\n\n    get svg() {\n        return this._svg;\n    }\n\n    updateScaleDomain() {\n        this.xScale = d3\n            .scaleLinear()\n            .domain([\n                1, this._length\n            ])\n            .range([\n                0, this._width\n            ]);\n    }\n\n    initZoom() {\n        this._zoom = d3.zoom()\n            .scaleExtent([1, 4])\n            .translateExtent([\n                [\n                    this.xScale(1), 0\n                ],\n                [this.width, 0]\n            ])\n            .on(\"zoom\", this.zoomed);\n    }\n\n    static get observedAttributes() {\n        return ['displaystart', 'displayend'];\n    }\n\n    attributeChangedCallback(name, oldValue, newValue) {\n        if (oldValue !== newValue) {\n            const value = parseFloat(newValue);\n            this[name] = isNaN(newValue) ? newValue : value;\n            this.applyZoomTranslation();\n        }\n    }\n\n    zoomed() {\n        this.xScale = d3.event.transform\n                .rescaleX(this._originXScale);\n        // this.refresh();\n        // Only refresh in the applyZoomTranslation\n\n        // If the source event is null the zoom wasn't initiated by this component, don't send event\n        if(this.dontDispatch) return;\n        this.dispatchEvent(new CustomEvent(\"change\", {\n            detail: {\n              displaystart: this.xScale.domain()[0],\n              displayend: this.xScale.domain()[1]\n            }, bubbles: true, cancelable: true\n        }));\n    }\n\n    applyZoomTranslation() {\n        if (!this.svg) return;\n        const k = Math.max (1, this.length / (this.displayend - this.displaystart));\n        const dx = -this._originXScale(this.displaystart);\n        this.dontDispatch = true;\n        this\n            .svg\n            // .transition()\n            // .duration(300)\n            .call(this.zoom.transform, d3.zoomIdentity.scale(k).translate(dx, 0));\n        this.dontDispatch = false;\n        this.refresh();\n    }\n\n    listenForResize() {\n        // TODO add sleep to make transition appear smoother. Could experiment with CSS3\n        // transitions too\n        window.onresize = () => {\n            this.width = this\n                .offsetWidth;\n            //TODO trigger repaint here\n        };\n    }\n\n}\n\nexport default ProtvistaZoomable;\n","import ProtvistaZoomable from './protvista-zoomable';\n\nconst loadComponent = function() {\n    customElements.define('protvista-zoomable', ProtvistaZoomable);\n};\n\n// Conditional loading of polyfill\nif (window.customElements) {\n    loadComponent();\n} else {\n    document.addEventListener('WebComponentsReady', function() {\n        loadComponent();\n    });\n}\n\nexport default ProtvistaZoomable;"],"names":["ProtvistaZoomable","style","display","width","offsetWidth","_length","getAttribute","parseFloat","displaystart","displayend","updateScaleDomain","bind","initZoom","zoomed","_applyZoomTranslation","applyZoomTranslation","aboutToApply","listenForResize","_originXScale","xScale","copy","d3","domain","range","_width","_zoom","scaleExtent","translateExtent","on","name","oldValue","newValue","value","isNaN","transform","rescaleX","dontDispatch","dispatchEvent","CustomEvent","bubbles","cancelable","svg","k","Math","max","length","dx","call","zoom","scale","translate","refresh","onresize","_xScale","_svg","HTMLElement","loadComponent","define","window","customElements","addEventListener"],"mappings":"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"}