{"version":3,"file":"protvista-zoomable.js","sources":["../src/protvista-zoomable.js","../src/main.js"],"sourcesContent":["import * as d3 from 'd3';\n\nclass ProtvistaZoomable extends HTMLElement {\n\n    constructor() {\n        super();\n\n        this.updateScaleDomain = this.updateScaleDomain.bind(this);\n        this.initZoom = this.initZoom.bind(this);\n        this.zoomed = this.zoomed.bind(this);\n        this._applyZoomTranslation = this.applyZoomTranslation.bind(this);\n        let aboutToApply = false;\n        this.applyZoomTranslation = () => {\n          if (aboutToApply) return;\n          aboutToApply = true;\n          requestAnimationFrame(() => {\n            aboutToApply = false;\n            this._applyZoomTranslation();\n          });\n        }\n        this.listenForResize = this.listenForResize.bind(this);\n\n    }\n    connectedCallback() {\n      this.style.display = 'block';\n      this.style.width = '100%';\n      this.width = this.offsetWidth;\n\n      this._length = this.getAttribute('length') ? parseFloat(this.getAttribute('length')) : 0;\n\n      this._displaystart = this.getAttribute('displaystart')\n          ? parseFloat(this.getAttribute('displaystart'))\n          : 0;\n      this._displayend = this.getAttribute('displayend')\n          ? parseFloat(this.getAttribute('displayend'))\n          : this.width;\n      this.updateScaleDomain();\n      this._originXScale = this.xScale.copy();\n      this.initZoom();\n      this.listenForResize();\n    }\n\n    get width() {\n        return this._width;\n    }\n\n    set width(width) {\n        this._width = width;\n    }\n\n    set length(length) {\n        this._length = length;\n    }\n\n    get length() {\n        return this._length;\n    }\n\n    get xScale() {\n        return this._xScale\n    }\n\n    set xScale(xScale) {\n        this._xScale = xScale;\n    }\n\n    get zoom() {\n        return this._zoom;\n    }\n\n    set svg(svg) {\n        this._svg = svg;\n        svg.call(this._zoom);\n        this.applyZoomTranslation();\n    }\n\n    get svg() {\n        return this._svg;\n    }\n\n    updateScaleDomain() {\n        this.xScale = d3\n            .scaleLinear()\n            .domain([\n                0, this._length\n            ])\n            .range([\n                0, this._width\n            ]);\n    }\n\n    initZoom() {\n        this._zoom = d3.zoom()\n            .scaleExtent([1, 4])\n            .translateExtent([\n                [\n                    this.xScale(1), 0\n                ],\n                [this.width, 0]\n            ])\n            .on(\"zoom\", this.zoomed);\n    }\n\n    static get observedAttributes() {\n        return ['displaystart', 'displayend'];\n    }\n\n    attributeChangedCallback(name, oldValue, newValue) {\n        if (oldValue !== newValue) {\n            const value = parseFloat(newValue);\n            this[`_${name}`] = isNaN(value) ? newValue : value;\n            this.applyZoomTranslation();\n        }\n    }\n\n    zoomed() {\n        this.xScale = d3.event.transform\n                .rescaleX(this._originXScale);\n        // this.refresh();\n        // Only refresh in the applyZoomTranslation\n\n        // If the source event is null the zoom wasn't initiated by this component, don't send event\n        if(this.dontDispatch) return;\n        this.dispatchEvent(new CustomEvent(\"change\", {\n            detail: {\n              displaystart: this.xScale.domain()[0],\n              displayend: this.xScale.domain()[1]\n            }, bubbles: true, cancelable: true\n        }));\n    }\n\n    applyZoomTranslation() {\n        if (!this.svg || !this._originXScale) return;\n        const k = Math.max (1, this.length / (this._displayend - this._displaystart));\n        const dx = -this._originXScale(this._displaystart);\n        this.dontDispatch = true;\n        this\n            .svg\n            // .transition()\n            // .duration(300)\n            .call(this.zoom.transform, d3.zoomIdentity.scale(k).translate(dx, 0));\n        this.dontDispatch = false;\n        this.refresh();\n    }\n\n    listenForResize() {\n        // TODO add sleep to make transition appear smoother. Could experiment with CSS3\n        // transitions too\n        window.addEventListener(\"resize\", e => {\n            this.width = this.offsetWidth;\n            this.updateScaleDomain();\n            this._originXScale = this.xScale.copy();\n            this.svg.attr('width', this.width)\n            this.applyZoomTranslation();\n        });\n    }\n\n}\n\nexport default ProtvistaZoomable;\n","import ProtvistaZoomable from './protvista-zoomable';\n\nconst loadComponent = function() {\n    customElements.define('protvista-zoomable', ProtvistaZoomable);\n};\n\n// Conditional loading of polyfill\nif (window.customElements) {\n    loadComponent();\n} else {\n    document.addEventListener('WebComponentsReady', function() {\n        loadComponent();\n    });\n}\n\nexport default ProtvistaZoomable;"],"names":["ProtvistaZoomable","updateScaleDomain","bind","initZoom","zoomed","_applyZoomTranslation","applyZoomTranslation","aboutToApply","listenForResize","style","display","width","offsetWidth","_length","getAttribute","parseFloat","_displaystart","_displayend","_originXScale","xScale","copy","d3","domain","range","_width","_zoom","scaleExtent","translateExtent","on","name","oldValue","newValue","value","isNaN","transform","rescaleX","dontDispatch","dispatchEvent","CustomEvent","bubbles","cancelable","svg","k","Math","max","length","dx","call","zoom","scale","translate","refresh","addEventListener","attr","_xScale","_svg","HTMLElement","loadComponent","define","window","customElements"],"mappings":"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"}